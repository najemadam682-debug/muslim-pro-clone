<script>
        let prayerTimes = {};
        let adhanAudio = new Audio('https://www.islamcan.com/audio/adhan/azan1.mp3'); // Link audio Adhan

        // Gestione Tab
        function showTab(id, btn) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active-nav'));
            document.getElementById(id).classList.add('active');
            btn.classList.add('active-nav');
            if(id === 'quran') loadQuran();
            if(id === 'qibla') loadQibla();
        }

        // Recupero Posizione e Orari
        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            fetch(`https://api.aladhan.com/v1/timingsByAddress?address=${lat},${lon}&method=3`)
                .then(res => res.json()).then(data => {
                    prayerTimes = data.data.timings;
                    updatePrayerUI(prayerTimes);
                    startAdhanCheck(); // Inizia a controllare l'orario
                });
        });

        function updatePrayerUI(t) {
            document.getElementById('city').innerText = "La tua posizione";
            document.getElementById('prayer-list').innerHTML = `
                <div class="prayer-row"><span>Fajr</span><b>${t.Fajr}</b></div>
                <div class="prayer-row"><span>Dhuhr</span><b>${t.Dhuhr}</b></div>
                <div class="prayer-row"><span>Asr</span><b>${t.Asr}</b></div>
                <div class="prayer-row"><span>Maghrib</span><b>${t.Maghrib}</b></div>
                <div class="prayer-row"><span>Isha</span><b>${t.Isha}</b></div>
                <button onclick="testAdhan()" style="margin-top:15px; width:100%; padding:10px; border-radius:10px; border:none; background:#00796b; color:white;">ðŸ”” Prova Suono Adhan</button>
            `;
        }

        // Funzione che controlla l'ora ogni minuto
        function startAdhanCheck() {
            setInterval(() => {
                const oraAttuale = new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
                const listaPreghiere = [prayerTimes.Fajr, prayerTimes.Dhuhr, prayerTimes.Asr, prayerTimes.Maghrib, prayerTimes.Isha];
                
                if (listaPreghiere.includes(oraAttuale)) {
                    playAdhan();
                }
            }, 60000); // 60000ms = 1 minuto
        }

        function playAdhan() {
            adhanAudio.play().catch(e => console.log("Attiva l'audio manualmente la prima volta"));
        }

        function testAdhan() {
            alert("L'Adhan suonerÃ  all'orario stabilito. Prova audio in corso...");
            playAdhan();
        }

        // --- Resto delle funzioni (Corano e Qibla) ---
        function loadQuran() {
            fetch('https://api.alquran.cloud/v1/ayah/262/it.piccardo')
                .then(res => res.json()).then(data => {
                    document.getElementById('verse-text').innerText = data.data.text;
                    document.getElementById('verse-translation').innerText = "Surah Al-Baqarah, Ayah 262";
                });
        }

        function loadQibla() {
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude; const lon = pos.coords.longitude;
                fetch(`https://api.aladhan.com/v1/qibla/${lat}/${lon}`)
                    .then(res => res.json()).then(data => {
                        const deg = data.data.direction;
                        document.getElementById('qibla-arrow').style.transform = `rotate(${deg}deg)`;
                        document.getElementById('qibla-deg').innerText = Math.round(deg) + "Â° rispetto al Nord";
                    });
            });
        }
    </script>
